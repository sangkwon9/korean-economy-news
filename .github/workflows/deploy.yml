name: Deploy Korean Economy News to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ìì • (UTC 15:00)ì— ì‹¤í–‰
    - cron: '0 15 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
        
    - name: Update news data
      run: |
        echo "ğŸš€ í•œêµ­ê²½ì œ ë‰´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹œì‘..."
        node update-news.js
        echo "âœ… ë‰´ìŠ¤ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Commit updated news data
      run: |
        if [ -f "news-data.json" ]; then
          git add news-data.json
          if git diff --staged --quiet; then
            echo "ğŸ“„ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ”„ ìë™ ë‰´ìŠ¤ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "âœ… ë‰´ìŠ¤ ë°ì´í„° ì»¤ë°‹ ì™„ë£Œ"
          fi
        else
          echo "âŒ news-data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: Push changes
      if: github.ref == 'refs/heads/main'
      run: |
        git push origin main || echo "í‘¸ì‹œí•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: Validate HTML
      run: |
        echo "ğŸ“ HTML êµ¬ì¡° ê²€ì¦ ì¤‘..."
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "âŒ Error: Missing DOCTYPE declaration"
          exit 1
        fi
        if ! grep -q "í•œêµ­ê²½ì œ ë‰´ìŠ¤ ëª¨ì•„ë³´ê¸°" index.html; then
          echo "âŒ Error: Title not found"
          exit 1
        fi
        echo "âœ… HTML ê²€ì¦ í†µê³¼"
        
    - name: Check CSS syntax
      run: |
        echo "ğŸ¨ CSS êµ¬ë¬¸ í™•ì¸ ì¤‘..."
        if [ -f styles.css ]; then
          echo "âœ… CSS íŒŒì¼ í™•ì¸ ì™„ë£Œ"
        else
          echo "âŒ Error: CSS file not found"
          exit 1
        fi
        
    - name: Validate JavaScript
      run: |
        echo "âš¡ JavaScript ê²€ì¦ ì¤‘..."
        if [ -f script.js ]; then
          echo "âœ… JavaScript íŒŒì¼ í™•ì¸ ì™„ë£Œ"
        else
          echo "âŒ Error: JavaScript file not found"
          exit 1
        fi
        
    - name: Check news data
      run: |
        echo "ğŸ“Š ë‰´ìŠ¤ ë°ì´í„° í™•ì¸ ì¤‘..."
        if [ -f news-data.json ]; then
          # JSON í˜•ì‹ ê²€ì¦
          if node -e "JSON.parse(require('fs').readFileSync('news-data.json', 'utf8'))"; then
            echo "âœ… ë‰´ìŠ¤ ë°ì´í„° JSON í˜•ì‹ ìœ íš¨"
            # ë‰´ìŠ¤ ê°œìˆ˜ í™•ì¸
            NEWS_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('news-data.json', 'utf8')).news.length)")
            echo "ğŸ“ˆ ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ê°œìˆ˜: $NEWS_COUNT"
            if [ "$NEWS_COUNT" -gt 0 ]; then
              echo "âœ… ë‰´ìŠ¤ ë°ì´í„° ê²€ì¦ í†µê³¼"
            else
              echo "âš ï¸ ê²½ê³ : ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "âŒ Error: Invalid JSON format in news-data.json"
            exit 1
          fi
        else
          echo "âš ï¸ ê²½ê³ : news-data.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°±ì—… ë°ì´í„° ì‚¬ìš©ë¨"
        fi
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github,README.md,.gitignore,deploy.sh,update-news.js,package.json,package-lock.json,node_modules'
        
    - name: Deployment notification
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ‰ í•œêµ­ê²½ì œ ë‰´ìŠ¤ ì›¹ì‚¬ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/korean-economy-news/"
        echo "â° í•œêµ­ì‹œê°„ ê¸°ì¤€: $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')"
        echo "ğŸ”„ ë‹¤ìŒ ìë™ ì—…ë°ì´íŠ¸: ë‚´ì¼ ìì • (00:00 KST)"
        
        if [ -f "news-data.json" ]; then
          NEWS_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('news-data.json', 'utf8')).news.length)")
          echo "ğŸ“Š í˜„ì¬ ë‰´ìŠ¤ ê°œìˆ˜: $NEWS_COUNT"
          LAST_UPDATE=$(node -e "console.log(JSON.parse(require('fs').readFileSync('news-data.json', 'utf8')).updateTime || 'ì •ë³´ ì—†ìŒ')")
          echo "ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $LAST_UPDATE"
        fi 