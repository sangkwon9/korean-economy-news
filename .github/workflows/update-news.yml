name: Update Korean Economy News

on:
  # ë§¤ì¼ í•œêµ­ ì‹œê°„ ì˜¤í›„ 4ì‹œ (UTC 7ì‹œ)ì— ì‹¤í–‰
  schedule:
    - cron: '0 7 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  update-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser xml2js axios
    
    - name: Fetch news data
      run: node fetch-news.js
      
    - name: Update news data in JavaScript
      run: |
        # news-data.jsonì„ script.jsì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ì²˜ë¦¬
        if [ -f "news-data.json" ]; then
          echo "ë‰´ìŠ¤ ë°ì´í„° íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # JavaScript íŒŒì¼ ì—…ë°ì´íŠ¸ - ì‹¤ì œ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
          cat > update-script.js << 'EOF'
          const fs = require('fs');
          
          // news-data.json íŒŒì¼ ì½ê¸°
          const newsData = JSON.parse(fs.readFileSync('news-data.json', 'utf8'));
          
          // script.js íŒŒì¼ ì—…ë°ì´íŠ¸
          let scriptContent = fs.readFileSync('script.js', 'utf8');
          
          // generateSampleNews í•¨ìˆ˜ ë‚´ìš©ì„ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´
          const newFetchFunction = `
          // ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (GitHub Actionsì—ì„œ ì—…ë°ì´íŠ¸ë¨)
          async fetchNewsData() {
              try {
                  // GitHub Pagesì—ì„œ ì—…ë°ì´íŠ¸ëœ ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ
                  const response = await fetch('./news-data.json?t=' + new Date().getTime());
                  if (!response.ok) {
                      throw new Error('ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                  }
                  const data = await response.json();
                  return data.news || [];
              } catch (error) {
                  console.error('ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                  // í´ë°±ìœ¼ë¡œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                  return this.generateSampleNews();
              }
          }`;
          
          // fetchNewsData í•¨ìˆ˜ êµì²´
          scriptContent = scriptContent.replace(
              /\/\/ ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°[\s\S]*?}$/m,
              newFetchFunction
          );
          
          fs.writeFileSync('script.js', scriptContent);
          console.log('âœ… script.js íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          EOF
          
          node update-script.js
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
        if git diff --quiet && git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git add news-data.json script.js
          git commit -m "ðŸ“° ë‰´ìŠ¤ ì—…ë°ì´íŠ¸ - $(date '+%Y-%m-%d %H:%M KST')"
          git push
          echo "âœ… ë‰´ìŠ¤ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: update-news
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # ì—…ë°ì´íŠ¸ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github,node_modules,*.md,package*.json,fetch-news.js,update-script.js' 